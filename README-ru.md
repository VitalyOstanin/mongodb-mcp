# MongoDB MCP Сервер

Также доступно на английском: [README.md](README.md)

[![CI](https://github.com/VitalyOstanin/mongodb-mcp/actions/workflows/ci.yml/badge.svg)](https://github.com/VitalyOstanin/mongodb-mcp/actions/workflows/ci.yml)
[![npm version](https://img.shields.io/npm/v/@vitalyostanin/mongodb-mcp.svg)](https://www.npmjs.com/package/@vitalyostanin/mongodb-mcp)

MCP сервер для всесторонней интеграции с MongoDB со следующими возможностями:

- **Операции с базами данных** - подключение к экземплярам MongoDB, список баз данных и коллекций
- **Управление документами** - поиск, агрегация и подсчет документов
- **Анализ схем** - анализ схем коллекций и индексов
- **Инструменты запросов** - выполнение запросов и агрегаций с полным синтаксисом MongoDB
- **Управление подключениями** - управление подключениями MongoDB с поддержкой режима только для чтения
- **Мониторинг** - статистика базы данных, метрики производительности и логи MongoDB
- **Анализ запросов** - анализ плана выполнения для оптимизации производительности

## Таблица содержимого

- [MongoDB MCP Сервер](#mongodb-mcp-сервер)
  - [Таблица содержимого](#таблица-содержимого)
  - [Требования](#требования)
  - [Установка](#установка)
    - [Использование npx (Рекомендуется)](#использование-npx-рекомендуется)
    - [Использование Claude MCP CLI](#использование-claude-mcp-cli)
    - [Ручная установка (Разработка)](#ручная-установка-разработка)
  - [Разработка и выпуск](#разработка-и-выпуск)
    - [Рабочие процессы GitHub Actions](#рабочие-процессы-github-actions)
      - [CI рабочий процесс (`.github/workflows/ci.yml`)](#ci-рабочий-процесс-githubworkflowsciyml)
      - [Рабочий процесс публикации (`.github/workflows/publish.yml`)](#рабочий-процесс-публикации-githubworkflowspublishyml)
    - [Настройка NPM_TOKEN](#настройка-npm_token)
    - [Процесс выпуска](#процесс-выпуска)
    - [Ручная сборка и тестирование](#ручная-сборка-и-тестирование)
  - [Запуск сервера (stdio)](#запуск-сервера-stdio)
  - [Конфигурация для Code (Рекомендуется)](#конфигурация-для-code-рекомендуется)
  - [Конфигурация для Claude Code CLI](#конфигурация-для-claude-code-cli)
  - [Конфигурация для VS Code Cline](#конфигурация-для-vs-code-cline)
  - [MCP Инструменты](#mcp-инструменты)
    - [Сервис](#сервис)
    - [Операции с базами данных](#операции-с-базами-данных)
    - [Операции с коллекциями](#операции-с-коллекциями)
    - [Операции с документами](#операции-с-документами)
    - [Анализ схем и индексов](#анализ-схем-и-индексов)
    - [Запросы и агрегация](#запросы-и-агрегация)
    - [Мониторинг и логи](#мониторинг-и-логи)
  - [Важные замечания](#важные-замечания)
    - [Режим только для чтения](#режим-только-для-чтения)
    - [Деструктивные операции](#деструктивные-операции)

## Требования

- Node.js ≥ 20
- Переменные окружения:
  - `MONGODB_CONNECTION_STRING` — строка подключения к MongoDB (в формате mongodb:// или mongodb+srv://)
  - `MONGODB_DEFAULT_DATABASE` — опциональное имя базы данных по умолчанию для операций
  - `MONGODB_TIMEZONE` — опциональная таймзона для операций с датами (по умолчанию: `Europe/Moscow`), должна быть валидным идентификатором IANA (например, `Europe/London`, `America/New_York`, `Asia/Tokyo`)

## Установка

### Использование npx (Рекомендуется)

Вы можете запустить сервер напрямую с помощью npx без установки:

```bash
MONGODB_CONNECTION_STRING="mongodb://localhost:27017" \
MONGODB_DEFAULT_DATABASE="myapp" \
npx -y @vitalyostanin/mongodb-mcp@latest
```

### Использование Claude MCP CLI

Установите с помощью Claude MCP CLI:

```bash
claude mcp add --scope user \
--env MONGODB_CONNECTION_STRING='mongodb://localhost:27017' \
--env MONGODB_DEFAULT_DATABASE='myapp' \
mongodb-mcp -- npx -y @vitalyostanin/mongodb-mcp@latest
```

**Варианты области действия:**
- `--scope user`: Установить для текущего пользователя (все проекты)
- `--scope project`: Установить только для текущего проекта

**Удаление:**

```bash
claude mcp remove mongodb-mcp --scope user
```

### Ручная установка (Разработка)

```bash
npm install
npm run build
```

## Разработка и выпуск

### Рабочие процессы GitHub Actions

Этот проект использует GitHub Actions для непрерывной интеграции и автоматических выпусков:

#### CI рабочий процесс (`.github/workflows/ci.yml`)

Запускается автоматически при каждом пуше и pull request:
- **Триггеры**: Все ветки, все pull request
- **Версии Node.js**: 20.x, 22.x (матричное тестирование)
- **Шаги**:
  1. Установка зависимостей (`npm ci`)
  2. Запуск линтера (`npm run lint`)
  3. Сборка проекта (`npm run build`)
  4. Проверка артефактов сборки (проверка исполняемого файла)

#### Рабочий процесс публикации (`.github/workflows/publish.yml`)

Запускается автоматически при создании нового тега версии:
- **Триггер**: Git теги, соответствующие шаблону `v*` (например, `v0.1.0`, `v1.2.3`)
- **Версия Node.js**: 20.x
- **Шаги**:
  1. Установка зависимостей
  2. Сборка проекта
  3. Публикация в npm registry
  4. Создание GitHub Release

### Настройка NPM_TOKEN

Чтобы включить автоматическую публикацию в npm, вам нужно настроить секрет `NPM_TOKEN`:

1. **Создание npm токена доступа**:
   - Перейдите на [npmjs.com](https://www.npmjs.com/) и войдите
   - Перейдите в **Access Tokens** в настройках аккаунта
   - Нажмите **Generate New Token** → **Classic Token**
   - Выберите тип **Automation** (для CI/CD)
   - Скопируйте сгенерированный токен

2. **Добавление секрета в GitHub**:
   - Перейдите в ваш репозиторий GitHub
   - Перейдите в **Settings** → **Secrets and variables** → **Actions**
   - Нажмите **New repository secret**
   - Имя: `NPM_TOKEN`
   - Значение: Вставьте ваш npm токен
   - Нажмите **Add secret**

### Процесс выпуска

Чтобы создать новый выпуск:

```bash
# 1. Обновите версию в package.json и создайте git тег
npm version patch   # для 0.1.0 → 0.1.1
# или
npm version minor   # для 0.1.0 → 0.2.0
# или
npm version major   # для 0.1.0 → 1.0.0

# 2. Загрузите тег в GitHub
git push --follow-tags

# 3. GitHub Actions автоматически:
#    - Запустит тесты и сборку
#    - Опубликует в npm
#    - Создаст GitHub Release
```

**Примечание**: Команда `npm version` автоматически:
- Обновляет `package.json` и `package-lock.json`
- Создает git коммит с сообщением вроде "0.1.1"
- Создает git тег вроде "v0.1.1"

### Ручная сборка и тестирование

```bash
# Установка зависимостей
npm install

# Сборка проекта
npm run build

# Запуск линтера
npm run lint

# Режим наблюдения для разработки
npm run dev:watch
```

## Запуск сервера (stdio)

```bash
MONGODB_CONNECTION_STRING="mongodb://localhost:27017" \
MONGODB_DEFAULT_DATABASE="myapp" \
node dist/index.js
```

## Конфигурация для Code (Рекомендуется)
Добавьте в `~/.code/config.toml`:
```toml
[mcp_servers.mongodb-mcp]
command = "npx"
args = ["-y", "@vitalyostanin/mongodb-mcp@latest"]

[mcp_servers.mongodb-mcp.env]
MONGODB_CONNECTION_STRING = "mongodb://localhost:27017"
MONGODB_DEFAULT_DATABASE = "myapp"
```

## Конфигурация для Claude Code CLI

Чтобы использовать этот MCP сервер с [Claude Code CLI](https://github.com/anthropics/claude-code), вы можете:

1. **Использовать Claude MCP CLI** - см. раздел [Установка](#установка) выше
2. **Ручная конфигурация** - добавьте в ваш файл `~/.claude.json`:

```json
{
  "mcpServers": {
    "mongodb-mcp": {
      "type": "stdio",
      "command": "npx",
      "args": ["-y", "@vitalyostanin/mongodb-mcp@latest"],
      "env": {
        "MONGODB_CONNECTION_STRING": "mongodb://localhost:27017",
        "MONGODB_DEFAULT_DATABASE": "myapp"
      }
    }
  }
}
```

**Примечание:** Эта конфигурация использует npx для запуска опубликованного пакета. Для локальной разработки используйте `"command": "node"` с `"args": ["/absolute/path/to/mongodb-mcp/dist/index.js"]`. Переменная окружения `MONGODB_TIMEZONE` является опциональной.

## Конфигурация для VS Code Cline

Чтобы использовать этот MCP сервер с расширением [Cline](https://github.com/cline/cline) в VS Code:

1. Откройте VS Code с установленным расширением Cline
2. Нажмите иконку MCP Servers в верхней навигации Cline
3. Выберите вкладку "Configure" и нажмите "Configure MCP Servers"
4. Добавьте следующую конфигурацию в `cline_mcp_settings.json`:

```json
{
  "mcpServers": {
    "mongodb-mcp": {
      "command": "npx",
      "args": ["-y", "@vitalyostanin/mongodb-mcp@latest"],
      "env": {
        "MONGODB_CONNECTION_STRING": "mongodb://localhost:27017",
        "MONGODB_DEFAULT_DATABASE": "myapp"
      }
    }
  }
}
```

**Примечание:** Эта конфигурация использует npx для запуска опубликованного пакета. Для локальной разработки используйте `"command": "node"` с `"args": ["/absolute/path/to/mongodb-mcp/dist/index.js"]`. Переменная окружения `MONGODB_TIMEZONE` является опциональной.

## MCP Инструменты

### Сервис

| Инструмент | Описание | Основные параметры |
| --- | --- | --- |
| `service_info` | Получить информацию о сервисе MongoDB, конфигурации окружения, версию и текущую таймзону | — |

### Операции с базами данных

| Инструмент | Описание | Основные параметры |
| --- | --- | --- |
| `connect` | Установить подключение к MongoDB с использованием строки подключения | `connectionString` — строка подключения MongoDB (необязательно, можно использовать переменную окружения) |
| `list_databases` | Список всех баз данных в экземпляре MongoDB | — |
| `db_stats` | Получить статистику для определенной базы данных | `database` — имя базы данных |

### Операции с коллекциями

| Инструмент | Описание | Основные параметры |
| --- | --- | --- |
| `list_collections` | Список всех коллекций для заданной базы данных | `database` — имя базы данных |
| `collection_schema` | Анализ схемы для коллекции | `database` — имя базы данных, `collection` — имя коллекции, опционально `sampleSize` (по умолчанию 50) |
| `collection_indexes` | Описание индексов для коллекции | `database` — имя базы данных, `collection` — имя коллекции |
| `collection_storage_size` | Получить размер коллекции | `database` — имя базы данных, `collection` — имя коллекции |

### Операции с документами

| Инструмент | Описание | Основные параметры |
| --- | --- | --- |
| `find` | Запуск find-запросов к коллекции MongoDB | `database` — имя базы данных, `collection` — имя коллекции, опционально `filter`, `limit` (по умолчанию 10), `projection`, `sort` |
| `count` | Подсчет документов в коллекции MongoDB | `database` — имя базы данных, `collection` — имя коллекции, опционально `query` — фильтр для подсчета |

### Анализ схем и индексов

| Инструмент | Описание | Основные параметры |
| --- | --- | --- |
| `collection_schema` | Описать схему для коллекции путем выборки документов | `database` — имя базы данных, `collection` — имя коллекции, опционально `sampleSize` (по умолчанию 50) |
| `collection_indexes` | Описание индексов для коллекции | `database` — имя базы данных, `collection` — имя коллекции |

### Запросы и агрегация

| Инструмент | Описание | Основные параметры |
| --- | --- | --- |
| `aggregate` | Запуск агрегации к коллекции MongoDB | `database` — имя базы данных, `collection` — имя коллекции, `pipeline` — массив стадий агрегации |
| `explain` | Возвращает статистику, описывающую выполнение выигрышного плана, выбранного оптимизатором запросов | `database` — имя базы данных, `collection` — имя коллекции, `method` — объект метода с именем и аргументами, опционально `verbosity` (по умолчанию 'queryPlanner') |

### Мониторинг и логи

| Инструмент | Описание | Основные параметры |
| --- | --- | --- |
| `mongodb_logs` | Возвращает самые последние записанные события mongod | опционально `limit` (по умолчанию 50), `type` (по умолчанию 'global', или 'startupWarnings') |

## Важные замечания

### Режим только для чтения

Сервер поддерживает режим только для чтения, который предотвращает разрушительные операции:

- **Защита только для чтения**: Когда используется флаг `--read-only` (по умолчанию) или переменная окружения `MONGODB_READONLY` установлена в 'true', операции записи заблокированы. Используйте `--read-only=false`, чтобы разрешить операции записи.
- **Защищенные операции**: операции `update`, `delete`, `insert`, `$out` и `$merge` запрещены
- **Безопасность подключения**: Режим только для чтения гарантирует, что случайные изменения данных не произойдут

### Деструктивные операции

Сервер MongoDB MCP работает в режиме только для чтения по умолчанию, чтобы предотвратить случайную потерю данных. Некоторые операции, которые могут изменить данные, ограничены и будут доступны только в режиме чтения-записи (который не включен по умолчанию).